#!/bin/bash
# overnight - Control the overnight organization job
# Usage: overnight [status|run|logs|enable|disable]

set -e

PLIST="$HOME/Library/LaunchAgents/com.id8labs.overnight-organize.plist"
SCRIPT="$HOME/Development/scripts/overnight-organize.sh"
LOGS_DIR="$HOME/Library/Logs/claude-overnight"
LABEL="com.id8labs.overnight-organize"

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

cmd_status() {
    echo -e "${BLUE}Overnight Organization Job Status${NC}"
    echo ""

    # Check if loaded
    if launchctl list | grep -q "$LABEL"; then
        echo -e "${GREEN}[LOADED]${NC} Job is registered with launchd"

        # Check last run
        local last_log=$(ls -t "$LOGS_DIR"/organize-*.log 2>/dev/null | head -1)
        if [[ -n "$last_log" ]]; then
            local last_date=$(basename "$last_log" | sed 's/organize-//' | sed 's/.log//')
            echo -e "${BLUE}Last run:${NC} $last_date"
        fi
    else
        echo -e "${YELLOW}[NOT LOADED]${NC} Job is not registered"
        echo "  Run: overnight enable"
    fi

    echo ""
    echo -e "${BLUE}Schedule:${NC} Daily at 3:00 AM"
    echo -e "${BLUE}Script:${NC} $SCRIPT"
    echo -e "${BLUE}Logs:${NC} $LOGS_DIR/"
    echo ""

    # Show recent reports
    local reports=$(ls -t "$LOGS_DIR"/report-*.md 2>/dev/null | head -3)
    if [[ -n "$reports" ]]; then
        echo -e "${BLUE}Recent Reports:${NC}"
        for r in $reports; do
            echo "  $(basename "$r")"
        done
    fi
}

cmd_run() {
    echo -e "${BLUE}Running overnight organization NOW...${NC}"
    echo "This may take several minutes."
    echo ""

    # Run the script directly
    "$SCRIPT"
}

cmd_logs() {
    local log_file="${1:-}"

    if [[ -z "$log_file" ]]; then
        # Show latest log
        log_file=$(ls -t "$LOGS_DIR"/organize-*.log 2>/dev/null | head -1)
    fi

    if [[ -n "$log_file" ]] && [[ -f "$log_file" ]]; then
        echo -e "${BLUE}Log file:${NC} $log_file"
        echo ""
        cat "$log_file"
    else
        echo "No logs found in $LOGS_DIR/"
    fi
}

cmd_report() {
    local report_file=$(ls -t "$LOGS_DIR"/report-*.md 2>/dev/null | head -1)

    if [[ -n "$report_file" ]] && [[ -f "$report_file" ]]; then
        echo -e "${BLUE}Latest Report:${NC} $report_file"
        echo ""
        cat "$report_file"
    else
        echo "No reports found. Run: overnight run"
    fi
}

cmd_enable() {
    echo -e "${BLUE}Enabling overnight organization job...${NC}"

    if [[ ! -f "$PLIST" ]]; then
        echo -e "${RED}Error:${NC} Plist not found: $PLIST"
        exit 1
    fi

    launchctl load "$PLIST"
    echo -e "${GREEN}[OK]${NC} Job enabled. Will run at 3:00 AM daily."
}

cmd_disable() {
    echo -e "${YELLOW}Disabling overnight organization job...${NC}"

    launchctl unload "$PLIST" 2>/dev/null || true
    echo -e "${GREEN}[OK]${NC} Job disabled."
}

cmd_help() {
    echo "overnight - Control the overnight file organization job"
    echo ""
    echo "Commands:"
    echo "  status    Show job status and recent runs"
    echo "  run       Run organization NOW (manually)"
    echo "  logs      Show latest log file"
    echo "  report    Show latest summary report"
    echo "  enable    Enable the daily 3 AM schedule"
    echo "  disable   Disable the scheduled job"
    echo ""
    echo "The job organizes:"
    echo "  - ~/Downloads/ (by file type)"
    echo "  - ~/Desktop/00-inbox/ (by file type)"
    echo "  - ~/Desktop/ (screenshots to archive)"
    echo "  - Old files to ~/Documents/Archive/"
}

# Main
CMD="${1:-status}"

case "$CMD" in
    status|s)
        cmd_status
        ;;
    run|now)
        cmd_run
        ;;
    logs|log|l)
        cmd_logs "$2"
        ;;
    report|r)
        cmd_report
        ;;
    enable|on|start)
        cmd_enable
        ;;
    disable|off|stop)
        cmd_disable
        ;;
    help|h|-h|--help)
        cmd_help
        ;;
    *)
        echo "Unknown command: $CMD"
        cmd_help
        exit 1
        ;;
esac
