#!/bin/bash
# proj - Quick project navigator and launcher
# Usage: proj [project] [action]
#
# Examples:
#   proj                    # List all projects with status
#   proj homer              # cd to Homer, show status
#   proj homer dev          # cd to Homer, start dev server
#   proj homer test         # cd to Homer, run tests
#   proj homer health       # cd to Homer, run full health check
#
# This replaces the pattern: cd ~/Development/Homer && git status && pnpm dev

set -e

DEV_DIR="$HOME/Development"
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

# Project aliases (add more as needed)
declare -A PROJECTS=(
    ["homer"]="Homer"
    ["h"]="Homer"
    ["xplace"]="x-place"
    ["x"]="x-place"
    ["aiplaces"]="x-place"
    ["id8"]="id8"
    ["pura"]="pura-vida"
    ["pv"]="pura-vida"
    ["lobe"]="lobehub-local"
)

# Detect package manager
detect_pm() {
    local dir="$1"
    if [[ -f "$dir/pnpm-lock.yaml" ]]; then
        echo "pnpm"
    elif [[ -f "$dir/yarn.lock" ]]; then
        echo "yarn"
    elif [[ -f "$dir/package-lock.json" ]]; then
        echo "npm"
    elif [[ -f "$dir/bun.lockb" ]]; then
        echo "bun"
    else
        echo "npm"
    fi
}

# Get project directory
get_project_dir() {
    local proj="${1,,}"  # lowercase
    local resolved="${PROJECTS[$proj]:-$proj}"

    if [[ -d "$DEV_DIR/$resolved" ]]; then
        echo "$DEV_DIR/$resolved"
    elif [[ -d "$DEV_DIR/$proj" ]]; then
        echo "$DEV_DIR/$proj"
    else
        return 1
    fi
}

# Show project status
show_status() {
    local dir="$1"
    local pm=$(detect_pm "$dir")

    echo -e "${BLUE}Project:${NC} $(basename "$dir")"
    echo -e "${BLUE}Path:${NC} $dir"
    echo -e "${BLUE}Package Manager:${NC} $pm"
    echo ""

    cd "$dir"

    # Git status (brief)
    if [[ -d ".git" ]]; then
        local branch=$(git branch --show-current 2>/dev/null || echo "detached")
        local status=$(git status --porcelain 2>/dev/null | wc -l | tr -d ' ')

        if [[ "$status" -eq 0 ]]; then
            echo -e "${GREEN}Git:${NC} $branch (clean)"
        else
            echo -e "${YELLOW}Git:${NC} $branch ($status changes)"
        fi
    fi

    # Check for running dev server
    local port_3000=$(lsof -ti:3000 2>/dev/null || true)
    local port_3001=$(lsof -ti:3001 2>/dev/null || true)

    if [[ -n "$port_3000" ]]; then
        echo -e "${GREEN}Dev Server:${NC} Running on :3000 (PID: $port_3000)"
    elif [[ -n "$port_3001" ]]; then
        echo -e "${GREEN}Dev Server:${NC} Running on :3001 (PID: $port_3001)"
    else
        echo -e "${YELLOW}Dev Server:${NC} Not running"
    fi

    echo ""
}

# List all projects
list_projects() {
    echo -e "${BLUE}Available Projects:${NC}"
    echo ""

    for dir in "$DEV_DIR"/*; do
        if [[ -d "$dir" ]] && [[ -f "$dir/package.json" ]]; then
            local name=$(basename "$dir")
            local pm=$(detect_pm "$dir")

            # Check git status
            local git_status=""
            if [[ -d "$dir/.git" ]]; then
                cd "$dir"
                local changes=$(git status --porcelain 2>/dev/null | wc -l | tr -d ' ')
                if [[ "$changes" -gt 0 ]]; then
                    git_status="${YELLOW}($changes changes)${NC}"
                else
                    git_status="${GREEN}(clean)${NC}"
                fi
                cd - > /dev/null
            fi

            printf "  %-20s %s %s\n" "$name" "[$pm]" "$git_status"
        fi
    done

    echo ""
    echo "Usage: proj <name> [dev|test|health|build|lint]"
}

# Run action
run_action() {
    local dir="$1"
    local action="$2"
    local pm=$(detect_pm "$dir")

    cd "$dir"

    case "$action" in
        dev|start)
            echo -e "${BLUE}Starting dev server...${NC}"
            $pm run dev
            ;;
        test)
            echo -e "${BLUE}Running tests...${NC}"
            $pm test
            ;;
        build)
            echo -e "${BLUE}Building...${NC}"
            $pm run build
            ;;
        lint)
            echo -e "${BLUE}Linting...${NC}"
            $pm run lint
            ;;
        health|check)
            echo -e "${BLUE}Running health check...${NC}"
            echo ""

            # Type check
            echo "TypeScript check..."
            if $pm exec tsc --noEmit 2>/dev/null; then
                echo -e "${GREEN}[OK]${NC} No type errors"
            else
                echo -e "${RED}[FAIL]${NC} Type errors found"
            fi

            # Lint
            echo "Lint check..."
            if $pm run lint 2>/dev/null; then
                echo -e "${GREEN}[OK]${NC} No lint errors"
            else
                echo -e "${YELLOW}[WARN]${NC} Lint issues found"
            fi

            # Tests
            echo "Test check..."
            if $pm test 2>/dev/null; then
                echo -e "${GREEN}[OK]${NC} Tests passing"
            else
                echo -e "${RED}[FAIL]${NC} Tests failing"
            fi
            ;;
        install|i)
            echo -e "${BLUE}Installing dependencies...${NC}"
            $pm install
            ;;
        *)
            echo "Unknown action: $action"
            echo "Available: dev, test, build, lint, health, install"
            exit 1
            ;;
    esac
}

# Main
PROJECT="${1:-}"
ACTION="${2:-}"

if [[ -z "$PROJECT" ]]; then
    list_projects
    exit 0
fi

PROJECT_DIR=$(get_project_dir "$PROJECT")

if [[ -z "$PROJECT_DIR" ]]; then
    echo -e "${RED}Error:${NC} Project not found: $PROJECT"
    echo ""
    list_projects
    exit 1
fi

show_status "$PROJECT_DIR"

if [[ -n "$ACTION" ]]; then
    run_action "$PROJECT_DIR" "$ACTION"
else
    # Just cd to the project (for sourcing)
    echo "cd $PROJECT_DIR"
fi
